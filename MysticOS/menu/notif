-- MysticOS Notification Menu

-- TODO: keyboard support

-- Colors
local backColor = colors.lime
local textColor = colors.white
local btnBackColor = colors.red
local btnTxtColor = colors.gray
local msgBackColor = colors.blue
local msgTxtColor = colors.red

local nScroll = 0

local function removeNotification(i)
	local notifications = os.listNotifications()
	if notifications[i] then
		os.removeNotification(notifications[i].id)
	end
end

local function readNotification(i)
	local notifications = os.listNotifications()
	if notifications[i] then
		local notif = notifications[i]
		-- TODO --
		gui.message(20, 5, notif.title, notif.msg, msgBackColor, msgTxtColor)
	end
end

local function redraw()
	graphics.clear(backColor)
	local notifications = os.listNotifications()
	local n = math.min(#notifications - nScroll, graphics.getHeight())
	for y = 1, n do
		graphics.setBackgroundColor(btnBackColor)
		graphics.setTextColor(btnTxtColor)
		graphics.drawChar("x", 1, y)
		graphics.setBackgroundColor(backColor)
		graphics.setTextColor(textColor)
		graphics.write(notifications[nScroll + y].title, 2, y)
	end
end

local function onClick(x, y)
	local i = nScroll + y
	if x == 1 then
		removeNotification(i)
	else
		readNotification(i)
	end
end

function scrollDown()
	local notifications = os.listNotifications()
	if #notifications > graphics.getHeight() and nScroll < #notifications then
		nScroll = nScroll + 1
	end
end

function scrollUp()
	if nScroll > 0 then
		nScroll = nScroll - 1
	end
end

while true do
	redraw()
	local evt, btn, x, y = os.pullEvent("mouse_click", "mouse_scroll", "key", "wake")
	if evt == "mouse_click" then
		if btn == 1 then
			onClick(x, y)
		end
	elseif evt == "mouse_scroll" then
		if btn == 1 then
			scrollDown()
		else
			scrollUp()
		end
	elseif evt == "key" then
		if btn == keys.up then
			scrollUp()
		elseif btn == keys.down then
			scrollDown()
		end
	end
end