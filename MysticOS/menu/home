-- MysticOS Home Menu

-- TODO: keyboard support

-- Colors
local backColor = colors.lightGray
local textColor = colors.white

local nScroll = 0

local sPath = "/usr/programs"
local tProgramsList

local function updateList()
	tProgramsList = fs.list(sPath)
	table.sort(tProgramsList)
end

local function getList()
	if not tProgramsList then
		updateList()
	end
	return tProgramsList
end

local function run(name)
	local ok, err = os.run(fs.combine(sPath, name))
	if not ok then
		-- TODO --
	end
end

local function redraw()
	graphics.setBackgroundColor(backColor)
	graphics.setTextColor(textColor)
	graphics.clear()
	local list = getList()
	local n = math.min(#list - nScroll, graphics.getHeight())
	for y = 1, n do
		graphics.write(list[nScroll + y], 1, y)
	end
end

local function onClick(x, y)
	local list = getList()
	local i = nScroll + y
	if i <= #list then
		run(list[i])
	end
end

function scrollDown()
	if #tMenuOptions > graphics.getHeight() and nScroll < #tMenuOptions then
		nScroll = nScroll + 1
	end
end

function scrollUp()
	if nScroll > 0 then
		nScroll = nScroll - 1
	end
end

while true do
	redraw()
	local evt, btn, x, y = os.pullEvent("mouse_click", "mouse_scroll", "key", "wake")
	if evt == "mouse_click" then
		if btn == 1 then
			onClick(x, y)
		end
	elseif evt == "mouse_scroll" then
		if btn == 1 then
			scrollDown()
		else
			scrollUp()
		end
	elseif evt == "key" then
		if btn == keys.up then
			scrollUp()
		elseif btn == keys.down then
			scrollDown()
		end
	end
end